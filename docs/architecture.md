# 架构设计文档

## 1. 概述

SSH Channels Hub 是一个用于管理和维护多个 SSH channels 的 CLI 应用程序。它通过配置文件定义需要建立的 SSH 连接，自动管理连接生命周期，并在连接断开时自动重连。

## 2. 系统架构

### 2.1 整体架构

```plaintext
┌─────────────────────────────────────────────────────────┐
│                    CLI Interface                        │
│                  (clap-based CLI)                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  Service Manager                        │
│         (管理所有 SSH channels 的生命周期)                    │
└──────┬───────────────────────────────────┬──────────────┘
       │                                   │
       ▼                                   ▼
┌──────────────────┐            ┌──────────────────┐
│  SSH Manager 1   │            │  SSH Manager N   │
│  (Channel 1)     │            │  (Channel N)     │
└────────┬─────────┘            └────────┬─────────┘
         │                               │
         ▼                               ▼
┌──────────────────┐            ┌──────────────────┐
│   russh Client   │            │   russh Client   │
│   Connection     │            │   Connection     │
└──────────────────┘            └──────────────────┘
```

### 2.2 核心组件

#### 2.2.1 CLI 模块 (`cli.rs`)

- **职责**: 解析命令行参数，提供用户接口
- **功能**:
  - `start`: 启动服务
  - `stop`: 停止服务
  - `restart`: 重启服务
  - `status`: 查看服务状态
  - `validate`: 验证配置文件

#### 2.2.2 配置模块 (`config.rs`)

- **职责**: 加载和解析 TOML 配置文件
- **功能**:
  - 解析 hosts 和 channels 配置
  - 解析认证配置（密码/密钥）
  - 解析重连策略配置
  - 提供默认配置路径

#### 2.2.3 服务管理模块 (`service.rs`)

- **职责**: 管理所有 SSH channels 的生命周期
- **功能**:
  - 启动所有配置的 channels
  - 停止所有 channels
  - 监控服务状态
  - 处理 channels 启动失败的情况

#### 2.2.4 SSH 管理模块 (`ssh.rs`)

- **职责**: 管理单个 SSH 连接和 channel
- **功能**:
  - 建立 SSH 连接
  - 处理认证（密码/密钥）
  - 打开和管理 SSH channel
  - 实现自动重连逻辑
  - 处理 channel 关闭和重开

#### 2.2.5 错误处理模块 (`error.rs`)

- **职责**: 定义应用级错误类型
- **功能**:
  - 使用 `thiserror` 定义结构化错误
  - 提供错误上下文信息
  - 错误类型转换

## 3. 数据流

### 3.1 启动流程

```plaintext
1. CLI 解析命令和参数
   ↓
2. 加载配置文件 (config.rs)
   ↓
3. 创建 ServiceManager
   ↓
4. 为每个 channel 创建 SshManager
   ↓
5. 每个 SshManager 启动独立任务
   ↓
6. SshManager 建立连接并打开 channel
   ↓
7. 监控连接状态，自动重连
```

### 3.2 重连流程

```plaintext
连接断开/channel 关闭
   ↓
检测到错误
   ↓
使用 backon 计算重试延迟
   ↓
等待延迟时间
   ↓
重新建立连接
   ↓
重新打开 channel
   ↓
继续监控
```

## 4. 并发模型

### 4.1 任务组织

- **主任务**: 运行 CLI 命令处理
- **服务任务**: 每个 channel 运行在独立的 `tokio::spawn` 任务中
- **channel 任务**: 每个 channel 内部可能有多个子任务处理数据流

### 4.2 同步原语

- **Arc<Mutex<>>**: 用于共享服务状态
- **tokio::sync::mpsc**: 用于任务间通信（如关闭信号）
- **tokio::select!**: 用于处理多个异步操作的竞争条件

## 5. 错误处理策略

### 5.1 错误分类

1. **配置错误**: 文件不存在、格式错误 → 立即失败
2. **连接错误**: 网络问题、服务器不可达 → 重试
3. **认证错误**: 密码错误、密钥无效 → 记录错误，跳过该 channel
4. **channel 错误**: channel 打开失败 → 重试

### 5.2 重试策略

- **指数退避**: 默认策略，适用于临时性错误
- **固定间隔**: 可选策略，适用于周期性重连
- **最大重试次数**: 可配置，防止无限重试

## 6. 扩展性设计

### 6.1 添加新的 channel 类型

1. 在 `config.rs` 中添加新的 channel 类型定义
2. 在 `ssh.rs` 中添加对应的处理函数
3. 在 `SshManager::establish_connection` 中添加新的分支

### 6.2 添加新的认证方式

1. 在 `config.rs` 的 `AuthConfig` 枚举中添加新变体
2. 在 `ssh.rs` 的 `connect_ssh_session` 中添加认证逻辑

### 6.3 添加新的重连策略

1. 在 `config.rs` 的 `ReconnectionConfig` 中添加配置选项
2. 在 `ssh.rs` 的 `connect_and_manage_channel` 中实现新策略

## 7. 性能考虑

### 7.1 资源管理

- 使用 `Arc` 共享配置，避免复制
- 及时释放不需要的连接资源
- 使用有界通道防止内存泄漏

### 7.2 并发优化

- 每个 channel 独立运行，互不阻塞
- 使用异步 I/O，避免阻塞线程
- 合理设置重试延迟，避免资源浪费

## 8. 安全性考虑

### 8.1 认证信息

- 配置文件中的密码以明文存储（建议使用密钥认证）
- 密钥文件路径支持 `~` 扩展
- 未来可考虑集成密钥管理服务

### 8.2 连接安全

- 默认接受所有服务器密钥（生产环境应验证）
- 支持所有 SSH 加密算法（由 russh 库决定）
- 建议在生产环境中启用服务器密钥验证

## 9. 日志和监控

### 9.1 日志级别

- `trace`: 详细的调试信息
- `debug`: 调试信息（channel 消息等）
- `info`: 重要事件（连接建立、channel 打开）
- `warn`: 警告信息（连接关闭）
- `error`: 错误信息（连接失败、认证失败）

### 9.2 结构化日志

使用 `tracing` 的结构化日志功能，包含：

- channel 名称
- host 地址
- 错误详情
- 时间戳（由 tracing-subscriber 提供）
